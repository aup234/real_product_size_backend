<div class="min-h-screen bg-gray-50 py-8">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <!-- Header -->
    <div class="text-center mb-8">
      <h1 class="text-3xl font-bold text-gray-900 mb-4">TripoAI v2 API Test</h1>
      <p class="text-lg text-gray-600 max-w-3xl mx-auto">
        Test the new TripoAI v2 API integration with real-time status updates.
        Select an image and generate a 3D model using the same flow as the mobile app.
      </p>
    </div>

    <!-- Task ID Check Section -->
    <div class="mb-8 bg-white rounded-lg shadow-sm p-6">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-semibold text-gray-900">Check Task Status by ID</h2>
        <%= if @task_checking_status == :checking do %>
          <span class="text-blue-600 flex items-center space-x-2">
            <svg class="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span>Checking...</span>
          </span>
        <% else %>
          <%= if @task_checking_status == :downloading do %>
            <span class="text-purple-600 flex items-center space-x-2">
              <svg class="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
              <span>Downloading...</span>
            </span>
          <% end %>
        <% end %>
      </div>

      <form phx-submit="check_task_status" phx-change="update_task_id" class="flex items-center gap-4 mb-4">
        <label class="flex-1">
          <.input
            type="text"
            name="task_id"
            value={@manual_task_id}
            placeholder="Enter task ID (e.g., 1ec04ced-4b87-44f6-a296-beee80777941)"
            class="w-full px-5 py-3.5 bg-gradient-to-r from-indigo-50 to-purple-50 border-2 border-indigo-200 rounded-xl text-gray-900 placeholder:text-indigo-400 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 focus:bg-gradient-to-r focus:from-indigo-100 focus:to-purple-100 transition-all duration-200 shadow-sm hover:shadow-md hover:border-indigo-300 font-mono text-sm"
            phx-debounce="300" />
        </label>
        <button
          type="submit"
          class="px-6 py-2 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed transition-colors duration-200 flex items-center space-x-2"
          disabled={@task_checking_status == :checking || @task_checking_status == :downloading || String.trim(@manual_task_id || "") == ""}>
          <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          <span>Check Status</span>
        </button>
      </form>

      <%= if @task_status_data do %>
        <div class="mt-4 p-4 bg-gray-50 rounded-lg border border-gray-200">
          <div class="space-y-2">
            <div class="flex items-center justify-between">
              <span class="text-sm font-medium text-gray-700">Task ID:</span>
              <span class="text-sm font-mono text-gray-900"><%= @task_status_data.task_id %></span>
            </div>
            <div class="flex items-center justify-between">
              <span class="text-sm font-medium text-gray-700">Status:</span>
              <span class={[
                "text-sm font-semibold",
                if(@task_status_data.status == "success", do: "text-green-600", else: ""),
                if(@task_status_data.status == "failed", do: "text-red-600", else: ""),
                if(@task_status_data.status in ["processing", "queued"], do: "text-blue-600", else: "")
              ]}>
                <%= String.capitalize(@task_status_data.status || "unknown") %>
              </span>
            </div>
            <%= if @task_status_data.pbr_model_url do %>
              <div class="flex items-center justify-between pt-2 border-t border-gray-200">
                <span class="text-sm font-medium text-gray-700">PBR Model Available:</span>
                <span class="text-sm text-green-600 font-semibold">✓ Yes</span>
              </div>
              <div class="pt-2 border-t border-gray-200">
                <%= if @task_status_data.status == "success" do %>
                  <p class="text-xs text-gray-600 mb-2">Model will be automatically downloaded...</p>
                <% else %>
                  <button
                    class="w-full px-4 py-2 bg-purple-600 text-white text-sm font-medium rounded-lg hover:bg-purple-700 disabled:bg-gray-400 disabled:cursor-not-allowed transition-colors duration-200"
                    phx-click="download_task_model"
                    phx-value-task_id={@task_status_data.task_id}
                    disabled={@task_checking_status == :downloading || is_nil(@task_status_data.pbr_model_url)}>
                    Download Model
                  </button>
                <% end %>
              </div>
            <% else %>
              <div class="pt-2 border-t border-gray-200">
                <p class="text-xs text-gray-600">PBR model not available yet. Status: <%= @task_status_data.status %></p>
              </div>
            <% end %>
            <%= if @task_status_data.response["progress"] do %>
              <div class="pt-2 border-t border-gray-200">
                <div class="flex justify-between text-xs text-gray-600 mb-1">
                  <span>Progress:</span>
                  <span><%= @task_status_data.response["progress"] %>%</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-1.5">
                  <div class="bg-blue-600 h-1.5 rounded-full transition-all duration-300"
                       style={"width: #{@task_status_data.response["progress"]}%"}></div>
                </div>
              </div>
            <% end %>
          </div>
        </div>
      <% end %>
    </div>

    <!-- Status Section -->
    <div class="mb-8 bg-white rounded-lg shadow-sm p-6">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-semibold text-gray-900">Generation Status</h2>
        <div class="flex items-center space-x-2">
          <span class="text-2xl"><%= status_icon(@generation_status) %></span>
          <span class={"text-lg font-medium #{status_color(@generation_status)}"}>
            <%= status_text(@generation_status) %>
          </span>
        </div>
      </div>

      <%= if @generation_status == :generating do %>
        <div class="mb-4">
          <div class="flex justify-between text-sm text-gray-600 mb-2">
            <span>Progress: <%= @progress %>%</span>
            <%= if @task_id do %>
              <span class="font-mono text-xs">Task: <%= String.slice(@task_id, 0, 8) %>...</span>
            <% end %>
          </div>
          <div class="w-full bg-gray-200 rounded-full h-2">
            <div class="bg-blue-600 h-2 rounded-full transition-all duration-300"
                 style={"width: #{@progress}%"}></div>
          </div>
        </div>
      <% end %>

      <%= if @generation_log do %>
        <div class="text-sm text-gray-600 space-y-1">
          <p><strong>Task ID:</strong> <span class="font-mono text-xs"><%= @generation_log.task_id %></span></p>
          <p><strong>Status:</strong> <%= @generation_log.status %></p>
          <%= if @generation_log.response_data do %>
            <p><strong>TripoAI Status:</strong> <%= get_in(@generation_log.response_data, ["status"]) || "N/A" %></p>
          <% end %>
        </div>
      <% end %>

      <%= if @error_message do %>
        <div class="mt-4 p-4 bg-red-50 border border-red-200 rounded-lg">
          <p class="text-sm text-red-800"><strong>Error:</strong> <%= @error_message %></p>
        </div>
      <% end %>
    </div>

    <!-- Debug Information Section -->
    <div class="mb-8 bg-blue-50 border border-blue-200 rounded-lg p-6">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-semibold text-blue-900">Real-time Debug Logs</h2>
        <button
          class="px-3 py-1 bg-blue-600 text-white text-sm rounded hover:bg-blue-700"
          phx-click="clear_debug_logs">
          Clear Logs
        </button>
      </div>

      <div class="bg-blue-100 rounded p-3 max-h-64 overflow-y-auto font-mono text-xs">
        <%= if @debug_logs && length(@debug_logs) > 0 do %>
          <%= for log <- Enum.reverse(@debug_logs) do %>
            <div class="text-blue-900 mb-1">
              <span class="text-blue-600">[<%= log.timestamp %>]</span>
              <span><%= log.message %></span>
            </div>
          <% end %>
        <% else %>
          <p class="text-blue-600 text-center py-4">No logs yet. Start a generation to see real-time updates.</p>
        <% end %>
      </div>

      <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
        <div>
          <h3 class="font-medium text-blue-800 mb-2">API Configuration</h3>
          <div class="space-y-1 text-blue-700">
            <p><strong>API URL:</strong> https://api.tripo3d.ai/v2</p>
            <p><strong>Endpoint:</strong> /openapi/task</p>
            <p><strong>Method:</strong> Async with polling</p>
          </div>
        </div>

        <div>
          <h3 class="font-medium text-blue-800 mb-2">Current State</h3>
          <div class="space-y-1 text-blue-700">
            <p><strong>Images Available:</strong> <%= length(@images) %></p>
            <p><strong>Selected:</strong> <%= if @selected_image, do: @selected_image.filename, else: "None" %></p>
            <p><strong>Status:</strong> <%= @generation_status %></p>
            <%= if @test_product do %>
              <p><strong>Test Product:</strong> <%= String.slice(@test_product.id, 0, 8) %>...</p>
            <% end %>
          </div>
        </div>
      </div>
    </div>

    <!-- Image Selection Section -->
    <div class="mb-8 bg-white rounded-lg shadow-sm p-6">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-semibold text-gray-900">Select Image for Generation</h2>
        <div class="text-sm text-gray-600">
          <%= if @selected_image, do: "1 selected", else: "None selected" %>
        </div>
      </div>

      <%= if length(@images) == 0 do %>
        <div class="text-center py-8 text-gray-500">
          <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
          </svg>
          <p class="mt-2">No images found in manual uploads directory</p>
          <p class="text-sm mt-1">Upload images to priv/static/product_imgs/manual/</p>
        </div>
      <% else %>
        <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">
          <%= for image <- @images do %>
            <% selected = @selected_image && @selected_image.filename == image.filename %>
            <div
              class={"relative group cursor-pointer border-2 rounded-lg overflow-hidden transition-all duration-200 #{if selected, do: "border-blue-500 ring-2 ring-blue-300", else: "border-gray-200 hover:border-blue-300"}"}
              phx-click="select_image"
              phx-value-filename={image.filename}>

              <div class="aspect-square bg-gray-100">
                <img src={image.url}
                     alt={image.filename}
                     class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-200">
              </div>

              <%= if selected do %>
                <div class="absolute top-2 right-2 bg-blue-600 text-white rounded-full p-1">
                  <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                  </svg>
                </div>
              <% end %>

              <div class="absolute bottom-0 left-0 right-0 bg-black bg-opacity-60 text-white p-2">
                <p class="text-xs truncate" title={image.filename}><%= image.filename %></p>
              </div>
            </div>
          <% end %>
        </div>
      <% end %>
    </div>

    <!-- Action Buttons -->
    <div class="mb-8 flex justify-center space-x-4">
      <%= if @selected_image && @generation_status in [:idle, :failed] do %>
        <button
          class="px-8 py-3 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 transition-colors duration-200 flex items-center space-x-2"
          phx-click="generate_model">
          <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 10l-2 1m0 0l-2-1m2 1v2.5M20 7l-2 1m2-1l-2-1m2 1v2.5M14 4l-2-1-2 1M4 7l2-1M4 7l2 1M4 7v2.5M12 21l-2-1m2 1l2-1m-2 1v-2.5M6 18l-2-1v-2.5M18 18l2-1v-2.5" />
          </svg>
          <span>Generate 3D Model</span>
        </button>
      <% else %>
        <button
          class="px-8 py-3 bg-gray-400 text-white font-medium rounded-lg cursor-not-allowed flex items-center space-x-2"
          disabled>
          <%= if @generation_status == :generating do %>
            <svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span>Generating...</span>
          <% else %>
            <span>Select Image to Generate</span>
          <% end %>
        </button>
      <% end %>

      <button
        class="px-8 py-3 bg-gray-600 text-white font-medium rounded-lg hover:bg-gray-700 transition-colors duration-200"
        phx-click="reset">
        Reset
      </button>
    </div>

    <!-- Model Viewer Section -->
    <%= if @model_url do %>
      <div class="bg-white rounded-lg shadow-sm p-6">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-xl font-semibold text-gray-900">Generated 3D Model</h2>
          <a href={@model_url}
             download={"#{@model_filename}"}
             class="px-4 py-2 bg-green-600 text-white text-sm font-medium rounded-lg hover:bg-green-700 transition-colors duration-200 flex items-center space-x-2">
            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
            </svg>
            <span>Download GLB</span>
          </a>
        </div>

        <div class="bg-gray-100 rounded-lg p-4">
          <model-viewer
            src={@model_url}
            alt="Generated 3D Model"
            auto-rotate
            camera-controls
            style="width: 100%; height: 500px; background-color: #f3f4f6;">
          </model-viewer>
        </div>

        <div class="mt-4 text-sm text-gray-600 space-y-1">
          <p><strong>Model URL:</strong> <a href={@model_url} class="text-blue-600 hover:underline break-all" target="_blank"><%= @model_url %></a></p>
          <p><strong>Filename:</strong> <%= @model_filename %></p>
        </div>
      </div>
    <% end %>

    <!-- Upload GLB File Section -->
    <div class="mt-8 bg-white rounded-lg shadow-sm p-6">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-semibold text-gray-900">Or Upload Existing GLB File</h2>
        <div class="text-sm text-gray-600">
          Max size: 50MB
        </div>
      </div>

      <form phx-submit="upload_glb" phx-change="validate_upload" class="flex items-center gap-4">
        <label class="flex-1">
          <.live_file_input upload={@uploads.glb_file} class="block w-full text-sm text-gray-600
            file:mr-4 file:py-2 file:px-4
            file:rounded-lg file:border-0
            file:text-sm file:font-semibold
            file:bg-purple-50 file:text-purple-700
            hover:file:bg-purple-100
            cursor-pointer" />
        </label>
        <button
          type="submit"
          class="px-6 py-2 bg-purple-600 text-white font-medium rounded-lg hover:bg-purple-700 disabled:bg-gray-400 disabled:cursor-not-allowed transition-colors duration-200"
          disabled={Enum.empty?(@uploads.glb_file.entries)}>
          Upload
        </button>
      </form>

      <%= for entry <- @uploads.glb_file.entries do %>
        <div class="mt-2">
          <div class="text-sm text-gray-600">
            <strong>File:</strong> <%= entry.client_name %>
            <span class="text-gray-400">(<%= format_file_size(entry.client_size) %>)</span>
          </div>
          <%= if entry.progress > 0 do %>
            <div class="mt-2 w-full bg-gray-200 rounded-full h-2">
              <div class="bg-purple-600 h-2 rounded-full transition-all duration-300" style={"width: #{entry.progress}%"}></div>
            </div>
          <% end %>
          <%= for err <- upload_errors(@uploads.glb_file, entry) do %>
            <div class="mt-2 text-sm text-red-600">Error: <%= error_to_string(err) %></div>
          <% end %>
        </div>
      <% end %>
    </div>

    <!-- Uploaded GLB Files List -->
    <%= if length(@uploaded_glb_files) > 0 do %>
      <div class="mt-8 bg-white rounded-lg shadow-sm p-6">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-xl font-semibold text-gray-900">Uploaded GLB Files</h2>
          <div class="text-sm text-gray-600">
            <%= length(@uploaded_glb_files) %> files
          </div>
        </div>

        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
          <%= for glb <- @uploaded_glb_files do %>
            <% selected_class = if @selected_glb == glb.filename, do: "border-purple-500 bg-purple-50", else: "border-gray-200" %>
            <div
              class={"border-2 rounded-lg p-4 transition-all duration-200 cursor-pointer hover:shadow-md #{selected_class}"}
              phx-click="select_glb"
              phx-value-filename={glb.filename}>
              <div class="flex items-start justify-between mb-2">
                <div class="flex-1 min-w-0">
                  <h3 class="font-medium text-sm text-gray-900 truncate" title={glb.filename}>
                    <%= glb.filename %>
                  </h3>
                  <p class="text-xs text-gray-500 mt-1">
                    <%= format_file_size(glb.size) %>
                  </p>
                </div>
                <button
                  class="ml-2 p-1 text-red-600 hover:text-red-800 hover:bg-red-50 rounded transition-colors"
                  phx-click="delete_glb"
                  phx-value-filename={glb.filename}
                  onclick="event.stopPropagation(); return confirm('Delete this file?');">
                  <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                  </svg>
                </button>
              </div>
              <%= if @selected_glb == glb.filename do %>
                <div class="text-xs text-purple-600 font-medium">✓ Selected for viewing</div>
              <% end %>
            </div>
          <% end %>
        </div>
      </div>
    <% end %>

    <!-- Instructions -->
    <div class="mt-8 bg-green-50 border border-green-200 rounded-lg p-6">
      <h3 class="text-lg font-medium text-green-900 mb-2">How It Works</h3>
      <div class="text-sm text-green-800 space-y-2">
        <p><strong>This test uses the actual production code path:</strong></p>
        <ol class="list-decimal list-inside space-y-1 ml-4">
          <li>Select an image from the gallery</li>
          <li>Click "Generate 3D Model" - this calls <code class="bg-green-100 px-1 rounded">TriPoService.generate_3d_model/1</code></li>
          <li>Task is submitted to TripoAI v2 API (<code class="bg-green-100 px-1 rounded">/v2/openapi/task</code>)</li>
          <li>Oban workers poll for status every 10 seconds using <code class="bg-green-100 px-1 rounded">TripoStatusPollerJob</code></li>
          <li>When complete, <code class="bg-green-100 px-1 rounded">DownloadTripoModelJob</code> downloads the GLB file</li>
          <li>Real-time updates via Phoenix PubSub (same as mobile app would receive)</li>
          <li>View the generated 3D model in the viewer</li>
        </ol>
        <p class="mt-4"><strong>Debug logs show:</strong> Task submission, polling attempts, progress updates, download status, and completion events.</p>
      </div>
    </div>
  </div>
</div>
